# code: language=ansible
---
- name: Check db already exists
  ansible.builtin.stat:
    path: "{{ postgres_data_dir }}"
  register: db_exists

- name: Start upgrade process
  become: true
  when: db_exists.stat.exists
  block:
  # from https://github.com/janLo/postgres-docker-upgrade/blob/master/playbook.yml

    - name: Backup data
      ansible.builtin.command: cp -a {{ postgres_data_dir }} {{ postgres_data_dir }}.backup
      changed_when: false

    - name: Create new data dir
      ansible.builtin.file:
        path: "{{ postgres_data_dir }}.new"
        state: directory
        mode: u=rwx,g=o=

    - name: Initialize new cluster
      community.docker.docker_container:
        pull: true
        name: pg_new_init
        image: "postgres:{{ postgres_new_version }}"
        env:
          POSTGRES_PASSWORD: '{{ postgres_password }}'
          POSTGRES_DB: '{{ postgres_db }}'
          POSTGRES_USER: '{{ postgres_user }}'
          PGDATA: /var/lib/postgresql/data
        volumes:
          - "{{ postgres_data_dir }}.new:/var/lib/postgresql/data"
        # command: "postgres --single {{ postgres_db }}"
        detach: true
        state: started
        ports:
          - 127.0.0.1:5432:5432

    - name: Wait for init container to be ready
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 5432
        state: started

    - name: Wait for database to be ready
      ansible.builtin.command: |
        docker exec pg_new_init pg_isready -h localhost -p 5432 -U {{ postgres_user }}
      register: pg_ready_result
      until: pg_ready_result.rc == 0
      retries: 30
      delay: 2
      changed_when: false

    - name: Remove init container
      community.docker.docker_container:
        name: pg_new_init
        state: absent

    - name: Start the old version
      community.docker.docker_container:
        pull: true
        name: pg_old_cnt
        image: "postgres:{{ postgres_old_version }}"
        volumes:
          - "/usr/lib/postgresql/{{ postgres_old_version }}"
          - "/usr/share/postgresql/{{ postgres_old_version }}"
        command: "/bin/bash"
        detach: true
        state: started

    - name: Start upgrade
      community.docker.docker_container:
        pull: true
        name: pg_new_cnt
        image: "postgres:{{ postgres_new_version }}"
        env:
          POSTGRES_PASSWORD: '{{ postgres_password }}'
          POSTGRES_DB: '{{ postgres_db }}'
          POSTGRES_USER: '{{ postgres_user }}'
        volumes:
          - "{{ postgres_data_dir }}:/tmp/old"
          - "{{ postgres_data_dir }}.new:/tmp/new"
        volumes_from:
          - pg_old_cnt
        user: postgres
        command: |
          "/bin/bash -c 'cd /tmp && /usr/lib/postgresql/{{ postgres_new_version }}/bin/pg_upgrade \
          -b /usr/lib/postgresql/{{ postgres_old_version }}/bin/ \
          -B /usr/lib/postgresql/{{ postgres_new_version }}/bin/ \
          -d /tmp/old/ -D /tmp/new/'"
        state: started
        detach: false

    - name: Wait for upgrade container to complete
      ansible.builtin.command: docker wait pg_new_cnt
      register: upgrade_exit_code
      changed_when: false

    - name: Display upgrade exit code
      ansible.builtin.debug:
        msg: "Upgrade container exit code: {{ upgrade_exit_code.stdout }}"

    - name: Display pg_new_cnt logs (stdout)
      ansible.builtin.command: docker logs pg_new_cnt
      register: pg_new_cnt_logs
      changed_when: false

    - name: Show pg_new_cnt logs (stdout)
      ansible.builtin.debug:
        msg: "{{ pg_new_cnt_logs.stdout }}"
      when: pg_new_cnt_logs.stdout | length > 0

    - name: Show pg_new_cnt logs (stderr)
      ansible.builtin.debug:
        msg: "{{ pg_new_cnt_logs.stderr }}"
      when: pg_new_cnt_logs.stderr | length > 0

    - name: Fail if upgrade unsuccessful
      ansible.builtin.fail:
        msg: "PostgreSQL upgrade failed with exit code {{ upgrade_exit_code.stdout }}"
      when: upgrade_exit_code.stdout != "0"

    - name: Cleanup migrate containers
      community.docker.docker_container:
        name: '{{ containers }}'
        state: absent
      loop:
        - pg_new_cnt
        - pg_old_cnt
      loop_control:
        loop_var: containers

    - name: Remove old data
      ansible.builtin.file:
        path: "{{ postgres_data_dir }}"
        state: absent

    - name: Move converted data
      ansible.builtin.command:
        cmd: mv {{ postgres_data_dir }}.new {{ postgres_data_dir }}
        creates: "{{ postgres_data_dir }}"

    - name: Run db for vacuum
      community.docker.docker_container:
        pull: true
        name: pg_new_vacuum
        image: "postgres:{{ postgres_new_version }}"
        env:
          POSTGRES_PASSWORD: '{{ postgres_password }}'
          POSTGRES_DB: '{{ postgres_db }}'
          POSTGRES_USER: '{{ postgres_user }}'
        volumes:
          - "{{ postgres_data_dir }}:/var/lib/postgresql/data"
        detach: true
        state: started
        ports:
          - 127.0.0.1:5432:5432

    - name: Wait for database start
      ansible.builtin.wait_for:
        port: 5432
        state: started

    - name: Wait for database to be ready
      ansible.builtin.command: |
        docker exec pg_new_vacuum pg_isready -h localhost -p 5432 -U {{ postgres_user }}
      register: pg_ready_result
      until: pg_ready_result.rc == 0
      retries: 30
      delay: 2
      changed_when: false

    - name: Exec vacuum
      ansible.builtin.command: |
        docker exec -u postgres pg_new_vacuum \
          /usr/lib/postgresql/{{ postgres_new_version }}/bin/vacuumdb \
          --username={{ postgres_user }} \
          --all \
          --analyze-in-stages
      changed_when: false

    - name: Remove vacuum container
      community.docker.docker_container:
        name: pg_new_vacuum
        state: absent
...

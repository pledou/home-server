# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/gitlab"
    state: directory
    mode: u=g=rwx,o=rx
- name: Create gitlab provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: gitlab-data
    - name: gitlab-config
- name: Copy gitlab config
  become: true
  ansible.builtin.template:
    src: gitlab.rb
    dest: "{{ docker_volumes_path }}/gitlab-config/gitlab.rb"
    mode: u=rw,g=o=r
- name: Retrive secret
  ansible.builtin.include_tasks: "tasks/retrieve_password.yml"
  vars:
    secrets:
      - gitlab_root_password

- name: Create docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/gitlab/docker-compose.yml
    mode: u=g=rwx,o=rx

- name: Try to pull latest images (continue on failure)
  community.docker.docker_compose_v2:
    pull: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/gitlab
  ignore_errors: true
  register: pull_result

- name: Warning - using local images
  ansible.builtin.debug:
    msg: "WARNING: Could not pull latest images. Deploying with existing local images."
  when: pull_result is failed

- name: Deploy compose from a compose file
  community.docker.docker_compose_v2:
    pull: "never"
    build: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/gitlab

# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/monitoring"
    state: directory
    mode: u=g=rwx,o=rx

- name: Create Monitoring provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: u=rwx,g=o=r
  loop:
    - name: prometheus-conf
    - name: promtail-conf
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - name: grafana-provisioning
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - name: alertmanager-conf
    - name: loki-config
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - name: nextcloud-exporter-conf

- name: Retrive secret
  ansible.builtin.include_tasks: "tasks/retrieve_password.yml"
  vars:
    secrets:
      - grafana_admin_password
      - name: alertmanager_nextcloud_bot_secret
        length: 64

- name: Ensure destination directory exists
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item }}"
    state: directory
    mode: u=rwx,g=o=rx
  loop:
    - grafana-provisioning/datasources
    - grafana-provisioning/dashboards

- name: Create configurations files as root
  become: true
  ansible.builtin.template:
    src: "{{ item.file }}"
    dest: "{{ docker_volumes_path }}/{{ item.dest }}"
    mode: u=rwx,g=o=rx
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
  loop:
    - file: prometheus.yml
      dest: prometheus-conf/prometheus.yml
    - file: loki.yml
      dest: loki-config/local-config.yaml
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - file: promtail-config.yml
      dest: promtail-conf/config.yml
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - file: grafana/datasources.yml
      dest: grafana-provisioning/datasources/datasource.yml
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
    - file: nextcloud-exporter-conf.yml
      dest: nextcloud-exporter-conf/config.yml
    - file: alertmanager-config.yml
      dest: alertmanager-conf/config.yml
  loop_control:
    label: "{{ item.file }} -> {{ item.dest }}"

- name: Copy configurations files
  become: true
  ansible.builtin.copy:
    src: "{{ item.file }}"
    dest: "{{ docker_volumes_path }}/{{ item.dest }}"
    mode: u=rwx,g=o=rx
  loop:
    - file: alerts.rules
      dest: prometheus-conf/alerts.rules
  loop_control:
    label: "{{ item.file }} -> {{ item.dest }}"

- name: Copy grafana dashboards
  become: true
  ansible.builtin.copy:
    src: templates/grafana/dashboards/
    dest: "{{ docker_volumes_path }}/grafana-provisioning/dashboards/"
    mode: u=rwx,g=o=rx
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Get Users infos
  ansible.builtin.getent:
    database: passwd
    key: "{{ ansible_user }}"

- name: Clone Nextcloud Talk webhook bot repository
  ansible.builtin.git:
    repo: https://github.com/pledou/nextcloud-talk-webhook-bot.git 
    # add Alertmanager json format support to https://github.com/weichwaren-schmiede/nextcloud-talk-webhook-bot.git
    # A MR has been opened here: https://github.com/weichwaren-schmiede/nextcloud-talk-webhook-bot/pull/1
    dest: /home/{{ ansible_user }}/home-server/stacks/monitoring/nextcloud-talk-bot
    version: main
    force: true
  when: alertmanager_nextcloud_conversation_token is defined and alertmanager_nextcloud_conversation_token

- name: Create docker-compose stack file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/monitoring/docker-compose.yml
    mode: u=g=rwx,o=rx

- name: Try to pull latest images (continue on failure)
  community.docker.docker_compose_v2:
    pull: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/monitoring
  ignore_errors: true
  register: pull_result

- name: Warning - using local images
  ansible.builtin.debug:
    msg: "WARNING: Could not pull latest images. Deploying with existing local images."
  when: pull_result is failed

- name: Deploy stack from a compose file
  community.docker.docker_compose_v2:
    pull: "never"
    build: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/monitoring

- name: Check if Nextcloud container exists
  ansible.builtin.shell:
    cmd: docker ps -a --filter "name=nc-nextcloud-1" --format "{{ '{{' }}.Names{{ '}}' }}"
  register: nextcloud_container_check
  changed_when: false
  failed_when: false

- name: Set nextcloud container exists fact
  ansible.builtin.set_fact:
    nextcloud_container:
      exists: "{{ 'nc-nextcloud-1' in nextcloud_container_check.stdout }}"

- name: Install Nextcloud Talk bot for alerts
  when:
    - nextcloud_container.exists | default(false)
    - alertmanager_nextcloud_conversation_token is defined
    - alertmanager_nextcloud_conversation_token | length > 0
  block:
    - name: Check if bot already exists
      ansible.builtin.command:
        cmd: docker exec nc-nextcloud-1 php occ talk:bot:list
      register: bot_list
      changed_when: false
      failed_when: false

    - name: Install Prometheus Alerts bot
      ansible.builtin.command:
        argv:
          - docker
          - exec
          - nc-nextcloud-1
          - php
          - occ
          - talk:bot:install
          - "Prometheus Alerts"
          - "{{ alertmanager_nextcloud_bot_secret }}"
          - "https://prometheus.{{ app_domain_name }}"
      when: "'Prometheus Alerts' not in bot_list.stdout"
      register: bot_install
      changed_when: bot_install.rc == 0
      failed_when:
        - bot_install.rc != 0
        - "'already exists' not in bot_install.stderr"

    - name: Get bot list to extract ID
      ansible.builtin.command:
        cmd: docker exec nc-nextcloud-1 php occ talk:bot:list
      register: bot_list_output
      changed_when: false

    - name: Extract Prometheus Alerts bot ID
      ansible.builtin.set_fact:
        prometheus_bot_id: "{{ bot_list_output.stdout | regex_search('\\|\\s+(\\d+)\\s+\\|\\s+Prometheus Alerts', '\\1') | first }}"

    - name: Add bot to conversation
      ansible.builtin.command:
        argv:
          - docker
          - exec
          - nc-nextcloud-1
          - php
          - occ
          - talk:bot:setup
          - "{{ prometheus_bot_id }}"
          - "{{ alertmanager_nextcloud_conversation_token }}"
      register: bot_setup
      changed_when: bot_setup.rc == 0
      failed_when:
        - bot_setup.rc != 0
        - "'already' not in bot_setup.stdout and 'already' not in bot_setup.stderr"

    - name: Display bot configuration result
      ansible.builtin.debug:
        msg: |
          Nextcloud Talk bot 'Prometheus Alerts' is fully configured and added to conversation {{ alertmanager_nextcloud_conversation_token }}.
          Alerts will now be sent to your Nextcloud Talk conversation!

- name: Configure Authentik providers and applications for Monitoring
  delegate_to: localhost
  become: false
  when: authentik_api_token is defined
  block:
    - name: Create Grafana role-mapping groups in Authentik
      when: authentik_api_token is defined
      block:
        - name: Create grafana-admin group
          ansible.builtin.uri:
            url: "https://auth.{{ app_domain_name }}/api/v3/core/groups/"
            method: POST
            headers:
              Authorization: "Bearer {{ authentik_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body:
              name: "grafana-admin"
              is_superuser: false
            status_code: [201, 400]
            validate_certs: true
          register: grafana_admin_group
          changed_when: grafana_admin_group.status == 201

        - name: Create grafana-editor group
          ansible.builtin.uri:
            url: "https://auth.{{ app_domain_name }}/api/v3/core/groups/"
            method: POST
            headers:
              Authorization: "Bearer {{ authentik_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body:
              name: "grafana-editor"
              is_superuser: false
            status_code: [201, 400]
            validate_certs: true
          register: grafana_editor_group
          changed_when: grafana_editor_group.status == 201

        - name: Create grafana-viewer group
          ansible.builtin.uri:
            url: "https://auth.{{ app_domain_name }}/api/v3/core/groups/"
            method: POST
            headers:
              Authorization: "Bearer {{ authentik_api_token }}"
              Content-Type: "application/json"
            body_format: json
            body:
              name: "grafana-viewer"
              is_superuser: false
            status_code: [201, 400]
            validate_certs: true
          register: grafana_viewer_group
          changed_when: grafana_viewer_group.status == 201

        - name: Display created groups
          ansible.builtin.debug:
            msg: |
              Grafana groups have been created in Authentik:
              - grafana-admin: Full administrative access
              - grafana-editor: Can create and edit dashboards
              - grafana-viewer: Read-only access to dashboards
              You can now assign users to these groups in the Authentik Admin Panel.

    - name: Configure Authentik providers and applications for Monitoring services
      when: authentik_api_token is defined
      ansible.builtin.include_tasks: "tasks/authentik_common.yml"
      vars:
        provider_apps:
          - provider:
              name: "alertmanager-provider"
              external_host: "https://alertmanager.{{ app_domain_name }}"
            app:
              name: "Alertmanager"
              slug: "alertmanager"
          - provider:
              name: "prometheus-provider"
              external_host: "https://prometheus.{{ app_domain_name }}"
            app:
              name: "Prometheus"
              slug: "prometheus"
        oauth_apps:
          - provider:
              name: "grafana-oauth-provider"
              client_id: "{{ grafana_oauth_client_id | default('grafana') }}"
              client_secret: "{{ grafana_oauth_client_secret }}"
              redirect_uris:
                - url: "https://grafana.{{ app_domain_name }}/login/generic_oauth"
                  matching_mode: "strict"
              client_type: "confidential"
              sub_mode: "user_email"
              include_claims_in_id_token: true
              issuer_mode: "per_provider"
              access_code_validity: "minutes=1"
              access_token_validity: "minutes=10"
              refresh_token_validity: "days=30"
              scopes: "openid profile email groups"
              property_mappings:
                - name: "grafana_mapper_role_admin"
                - name: "grafana_mapper_role_editor"
                - name: "grafana_mapper_role_viewer"
            app:
              name: "Grafana"
              slug: "grafana-slug"
              open_in_new_tab: true
              meta_launch_url: "https://grafana.{{ app_domain_name }}"
              meta_description: "Grafana monitoring and analytics platform"
              meta_publisher: "Grafana"
...

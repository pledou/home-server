---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/hassio"
    state: directory
    mode: u=g=rwx,o=rx
- name: Retrive secret
  ansible.builtin.include_tasks: "retrieve_password.yml"
  vars:
    secrets:
      - mqtt_password
- name: Create homeassistant provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: homeassistant
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: zigbee2mqtt
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: enocean2mqtt
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: esphome
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: mosquitto
    - name: myelectricaldata
      mode: u=rwx,g=rx,o=
      group: 0998
- name: Copy mosquitto config file
  become: true
  ansible.builtin.template:
    src: mosquitto.conf
    dest: "{{ docker_volumes_path }}/mosquitto/mosquitto.conf"
    mode: u=g=rwx,o=rx
    force: true
- name: Passlib pip package install
  become: true
  ansible.builtin.pip:
    name: passlib
    state: present
- name: Create mosquitto password file without mosquitto_passwd
  become: true
  ansible.builtin.copy:
    content: "{{ mqtt_user }}:{{ mqtt_password | mosquitto_passwd }}"
    dest: "{{ docker_volumes_path }}/mosquitto/mosquitto_passwords"
    mode: u=g=rwx,o=rx
    force: true
- name: Copy myelectricaldata config file
  become: true
  ansible.builtin.template:
    src: myelectricaldata.yaml
    dest: "{{ docker_volumes_path }}/myelectricaldata/config.yaml"
    mode: u=g=rwx,o=rx
    force: false
- name: Copy zigbee2mqtt config file
  become: true
  ansible.builtin.template:
    src: zigbee2mqtt.yaml
    dest: "{{ docker_volumes_path }}/zigbee2mqtt/configuration.yaml"
    mode: u=g=rwx,o=rx
    force: false
  when: zigbee2mqtt_device_id is defined
- name: Copy enocean2mqtt config file
  become: true
  ansible.builtin.template:
    src: templates/enocean2mqtt.conf
    dest: "{{ docker_volumes_path }}/enocean2mqtt/enoceanmqtt.conf"
    mode: u=g=rwx,o=rx
    force: true
  when: enocean_device_id is defined
- name: Copy enocean custom mappig config file
  become: true
  ansible.builtin.copy:
    src: mapping.yaml
    dest: "{{ docker_volumes_path }}/enocean2mqtt/mapping.yaml"
    mode: u=g=rwx,o=rx
    force: true
  when: enocean_device_id is defined
- name: Create docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/hassio/docker-compose.yml
    mode: u=g=rwx,o=rx
- name: Configure homeassistant for proxy
  become: true
  ansible.builtin.blockinfile:
    path: "{{ docker_volumes_path }}/homeassistant/configuration.yaml"
    block: |
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          - 127.0.0.1
          - 172.0.0.0/8
- name: Restore ha_enonceanmqtt git repo
  become: true
  ansible.builtin.git:
    repo: 'https://gitlab.leducd.duckdns.org/p.leduc/HA_enoceanmqtt.git'
    dest: "/home/{{ ansible_user }}/home-server/stacks/hassio/ha_enonceanmqtt"
    version: 'jenocean'
    single_branch: true
  environment:
    GIT_TERMINAL_PROMPT: 0 # reports "terminal prompts disabled" on missing password
  when: enocean_device_id is defined

- name: Deploy compose from a compose file
  become: true
  community.docker.docker_compose_v2:
    pull: "always"
    build: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/hassio
# - name: Fix bluepy dependency
#   community.docker.docker_container_exec:
#     container: hassio_homeassistant_1
#     argv:
#       - /bin/bash
#       - "-c"
#       - "pip install --find-links $WHEELS_LINKS bluepy"
...

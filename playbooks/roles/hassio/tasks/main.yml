---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/hassio"
    state: directory
    mode: u=rwx,go=
- name: Retrive secret
  ansible.builtin.include_tasks: "retrieve_password.yml"
  vars:
    secrets:
      - mqtt_password
- name: Create homeassistant provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: homeassistant
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: zigbee2mqtt
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: enocean2mqtt
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: esphome
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: mosquitto
    - name: myelectricaldata
      mode: u=rwx,g=rx,o=
      group: 0998
    - name: frigate_config
      mode: u=rwx,g=rx,o=
    - name: frigate_media
      mode: u=rwx,g=rx,o=

- name: Copy mosquitto config file
  become: true
  ansible.builtin.template:
    src: mosquitto.conf
    dest: "{{ docker_volumes_path }}/mosquitto/mosquitto.conf"
    mode: u=g=rwx,o=rx
    force: true
- name: Install passlib system package
  become: true
  ansible.builtin.apt:
    name: python3-passlib
    state: present
    update_cache: true
- name: Create mosquitto password file without mosquitto_passwd
  become: true
  ansible.builtin.copy:
    content: "{{ mqtt_user }}:{{ mqtt_password | mosquitto_passwd }}"
    dest: "{{ docker_volumes_path }}/mosquitto/mosquitto_passwords"
    mode: u=g=rwx,o=rx
    force: true
- name: Copy myelectricaldata config file
  become: true
  ansible.builtin.template:
    src: myelectricaldata.yaml
    dest: "{{ docker_volumes_path }}/myelectricaldata/config.yaml"
    mode: u=g=rwx,o=rx
    force: false
- name: Copy zigbee2mqtt config file
  become: true
  ansible.builtin.template:
    src: zigbee2mqtt.yaml
    dest: "{{ docker_volumes_path }}/zigbee2mqtt/configuration.yaml"
    mode: u=g=rwx,o=rx
    force: false
  when: zigbee2mqtt_device_id is defined
- name: Copy enocean2mqtt config file
  become: true
  ansible.builtin.template:
    src: templates/enocean2mqtt.conf
    dest: "{{ docker_volumes_path }}/enocean2mqtt/enoceanmqtt.conf"
    mode: u=g=rwx,o=rx
    force: true
  when: enocean_device_id is defined
- name: Copy enocean custom mappig config file
  become: true
  ansible.builtin.copy:
    src: mapping.yaml
    dest: "{{ docker_volumes_path }}/enocean2mqtt/mapping.yaml"
    mode: u=g=rwx,o=rx
    force: true
  when: enocean_device_id is defined
- name: Create docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/hassio/docker-compose.yml
    mode: u=g=rwx,o=rx
- name: Copy frigate config file
  become: true
  ansible.builtin.template:
    src: frigate.yaml
    dest: "{{ docker_volumes_path }}/frigate_config/config.yaml"
    mode: u=g=rwx,o=rx
    force: true
- name: Configure homeassistant for proxy
  become: true
  ansible.builtin.blockinfile:
    path: "{{ docker_volumes_path }}/homeassistant/configuration.yaml"
    block: |
      http:
        use_x_forwarded_for: true
        trusted_proxies:
          - 127.0.0.1
          - 172.0.0.0/8
- name: Configure UFW rules for Home Assistant services
  become: true
  vars:
    local_networks_v4:
      - "{{ (ansible_default_ipv4.address ~ '/' ~ ansible_default_ipv4.prefix) | ansible.utils.ipaddr('network/prefix') }}"
    local_networks_v6:
      - "{{ (ansible_default_ipv6.address ~ '/' ~ ansible_default_ipv6.prefix) | ansible.utils.ipaddr('network/prefix') }}"
      - "fe80::/10"  # Add link-local IPv6
    local_networks: "{{ local_networks_v4 + local_networks_v6 }}"
    internal_only_networks:
      - "127.0.0.1/8"
      - "fd00::1/8"
    ufw_rules:
      - name: "Home Assistant"
        port: "8123"
        cidrs: "{{ internal_only_networks }}"
      - name: "MQTT"
        port: "1883"
        cidrs: "{{ local_networks }}"
      - name: "MQTT TLS"
        port: "8883"
        cidrs: "{{ local_networks }}"
      - name: "ESPHome"
        port: "6052"
        cidrs: "{{ internal_only_networks }}"
      - name: "Zigbee2MQTT"
        port: "6053"
        cidrs: "{{ local_networks }}"
      - name: "CoAP"
        port: "5683"
        proto: "udp"
        cidrs: "{{ local_networks }}"
      - name: "HA Enoncean MQTT"
        port: "10200"
        cidrs: "{{ internal_only_networks }}"
      - name: "MyElectricalData"
        port: "10300"
        cidrs: "{{ internal_only_networks }}"
      - name: "Network UPS Tools"
        port: "3493"
        cidrs: "{{ internal_only_networks }}"
      - name: "IPP"
        port: "631"
        cidrs: "{{ local_networks }}"
      - name: "SSDP for local network"
        port: "1900"
        proto: "udp"
        cidrs: "{{ local_networks }}"
      - name: "SSDP responses"
        proto: "udp"
        from_port: "1900"
        cidrs: "{{ local_networks }}"
      - name: "mDNS for local network"
        port: "5353"
        proto: "udp"
        cidrs: "{{ local_networks }}"
      - name: "IGMP"
        proto: "igmp"
        cidrs: "{{ local_networks_v4 }}"   # IGMP is IPv4-only
      - name: "WS-Discovery"
        port: "3702"
        proto: "udp"
        cidrs: "{{ local_networks }}"
      - name: "RTSP for Frigate"
        port: "8554"
        cidrs: "{{ local_networks }}"
  community.general.ufw:
    rule: allow
    port: "{{ item.0.port | default(omit) }}"
    from_port: "{{ item.0.from_port | default(omit) }}"
    proto: "{{ item.0.proto | default('tcp') }}"
    from_ip: "{{ item.1 }}"
    comment: "{{ item.0.name }}"
  loop: "{{ ufw_rules | subelements('cidrs') }}"

# - name: Restore ha_enonceanmqtt git repo
#   become: true
#   ansible.builtin.git:
#     repo: 'https://gitlab.leducd.duckdns.org/p.leduc/HA_enoceanmqtt.git'
#     dest: "/home/{{ ansible_user }}/home-server/stacks/hassio/ha_enonceanmqtt"
#     version: 'jenocean'
#     single_branch: true
#   environment:
#     GIT_TERMINAL_PROMPT: "0" # reports "terminal prompts disabled" on missing password
#   when: enocean_device_id is defined

- name: Deploy compose from a compose file
  become: true
  community.docker.docker_compose_v2:
    pull: "always"
    build: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/hassio

- name: Configure Authentik providers and applications for Home Assistant services
  delegate_to: localhost
  become: false
  when: authentik_api_token is defined
  block:
    - name: Configure Authentik providers and applications for Home Assistant services
      ansible.builtin.include_tasks: "tasks/authentik_common.yml"
      vars:
        provider_apps:
          - provider:
              name: "esphome-provider"
              external_host: "https://esphome.{{ app_domain_name }}"
            app:
              name: "ESPHome"
              slug: "esphome"
          - provider:
              name: "myelectricaldata-provider"
              external_host: "https://myelectricaldata.{{ app_domain_name }}"
            app:
              name: "MyElectricalData"
              slug: "myelectricaldata"
          - provider:
              name: "zigbee2mqtt-provider"
              external_host: "https://zigbee2mqtt.{{ app_domain_name }}"
            app:
              name: "Zigbee2Mqtt"
              slug: "zigbee2mqtt"
          - provider:
              name: "frigate-provider"
              external_host: "https://frigate.{{ app_domain_name }}"
            app:
              name: "Frigate"
              slug: "frigate"

# - name: Fix bluepy dependency
#   community.docker.docker_container_exec:
#     container: hassio_homeassistant_1
#     argv:
#       - /bin/bash
#       - "-c"
#       - "pip install --find-links $WHEELS_LINKS bluepy"

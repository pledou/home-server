services:
  watchtower: # auto update images
    image: containrrr/watchtower
    environment:
      DOCKER_CONFIG: /config
    volumes:
      - /etc/watchtower/config/:/config/
      - /var/run/docker.sock:/var/run/docker.sock
    command: --schedule "15 2 * * 6 *"
    networks:
      backend:

  autoheal: # restart container when healthcheck is ko
    image: willfarrell/autoheal
    restart: always
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      AUTOHEAL_INTERVAL: 30   # check every 5 seconds
      AUTOHEAL_START_PERIOD: 120   # wait 0 seconds before first health check
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60   # Docker waits max 10 seconds (the Docker default) for a container to stop before killing during restarts (container overridable via label, see below)
    networks:
      backend:
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
  traefik:
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.http.routers.traefik-public-https.rule=Host(`traefik.{{ app_domain_name }}`)
      - traefik.http.routers.traefik-public-https.entrypoints=https
      - traefik.http.routers.traefik-public-https.tls=true
      # Use the special Traefik service api@internal with the web UI/Dashboard
      - traefik.http.routers.traefik-public-https.service=api@internal
      - traefik.http.routers.traefik-public-https.tls.certresolver=le
      - traefik.http.routers.traefik-public-https.middlewares=authentik@docker
      - traefik.http.services.traefik-public.loadbalancer.server.port=8585

      - traefik.http.routers.traefik-public-https.tls.domains[0].main={{ app_domain_name }}
      - traefik.http.routers.traefik-public-https.tls.domains[0].sans=*.{{ app_domain_name }}

      - traefik.http.middlewares.authentik.forwardauth.address=http://authentik-outpost:9000/outpost.goauthentik.io/auth/traefik
      - traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version

    environment:
      - DUCKDNS_TOKEN={{ traefik_duckdns_token }} #TODO protect this secret
    hostname: traefik
    image: traefik:latest
    restart: always    
    command:
      - --providers.docker
      - --providers.docker.watch
      - --providers.docker.exposedByDefault=false
      - --entrypoints.https.address=:443
      - --entrypoints.https.http3
      - --entrypoints.dot.address=:853
      - --certificatesresolvers.le.acme.email={{ traefik_email }}
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=duckdns
      - --entrypoints.https.http.tls.domains[0].main={{ app_domain_name }}
      - --entrypoints.https.http.tls.domains[0].sans=*.{{ app_domain_name }}
      - --accesslog
      - --log
      - --log.level=INFO
      - --api
      - --metrics.prometheus=true
      - --metrics.prometheus.addrouterslabels=true
      - --entryPoints.metrics.address=:8082
      - --metrics.prometheus.entryPoint=metrics
    networks:
      backend:
    extra_hosts:
      host.docker.internal: host-gateway

    ports:
      - "443:443/tcp"
      - "853:853/tcp"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - traefik-public-certificates:/certificates
      - traefik-rules:/rules

{% if unbound %}
  unbound:
    labels:
      - traefik.enable=true
      - traefik.tcp.routers.dot.rule=HostSNI(`dns.{{ app_domain_name }}`)
      - traefik.tcp.routers.dot.entrypoints=dot
      - traefik.tcp.routers.dot.tls=true
      - traefik.tcp.routers.dot.service=unbound-dot
      - traefik.tcp.services.unbound-dot.loadbalancer.server.port=53
    image: mvance/unbound:latest
    networks:
      backend:
    expose:
      - 53
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    volumes:
      - unbound:/opt/unbound/etc/unbound
    restart: unless-stopped
  
  doh-proxy:
    labels:
      - traefik.enable=true
      - traefik.http.routers.doh.rule=Host(`dns.{{ app_domain_name }}`) && Path(`/dns-query`)
      - traefik.http.routers.doh.entrypoints=https
      - traefik.http.routers.doh.tls=true
      - traefik.http.middlewares.doh-compression.compress=true
      - traefik.http.middlewares.doh-tls.headers.sslredirect=true
      - traefik.http.middlewares.doh-tls.headers.sslforcehost=true
      - traefik.http.routers.doh.tls.certresolver=le
      # Protection from requests flood
      - traefik.http.middlewares.doh-ratelimit.ratelimit.average=100
      - traefik.http.middlewares.doh-ratelimit.ratelimit.burst=50
      - traefik.http.middlewares.doh-ratelimit.ratelimit.period=10s
      - traefik.http.routers.doh.service=doh-svc
      - traefik.http.services.doh-svc.loadbalancer.server.port=8053
    build:
      context: ./doh/
      dockerfile: Dockerfile.server
    environment:
      - DEBUG="0"
      - UPSTREAM_DNS_SERVER="udp:unbound:53"
      - DOH_HTTP_PREFIX="/dns-query"
      - DOH_SERVER_LISTEN=:8053
      - DOH_SERVER_TIMEOUT=10
      - DOH_SERVER_TRIES=3
      - DOH_SERVER_VERBOSE=true
    depends_on:
      - unbound
    networks:
      - backend
    restart: unless-stopped
{% endif %}

  updateDuckDNSIP:
    # used to update DuckDNS
{% if duckdns_nonstatic %}
    command: /bin/sh -c "while true; do wget -O - 'https://www.duckdns.org/update?domains={{ duckdns_subdomain }}&token={{ traefik_duckdns_token }}&ip='; sleep 1200; done"
{% else %}
    command: /bin/sh -c "wget -O - 'https://www.duckdns.org/update?domains={{ duckdns_subdomain }}&token={{ traefik_duckdns_token }}&ip=&ipv6={{ my_ipv6_network.split('::')[0] }}:{{ eui64 }}'"
{% endif %}
    image: alpine:latest
    networks:
      backend:
    {% if duckdns_nonstatic %}
    restart: unless-stopped
    {% endif %}

networks:
  backend:
    enable_ipv6: true
    attachable: true

volumes:
  unbound:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/unbound"
  traefik-public-certificates:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-public-certificates"
  traefik-rules:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-rules"
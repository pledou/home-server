services:
  watchtower: # auto update images
    image: containrrr/watchtower
    environment:
      DOCKER_CONFIG: /config
    volumes:
      - /etc/watchtower/config/:/config/
      - /var/run/docker.sock:/var/run/docker.sock
    command: --schedule "15 2 * * * *"

  autoheal: # restart container when healthcheck is ko
    labels:
      - traefik.enable=false
    image: willfarrell/autoheal
    restart: always
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      AUTOHEAL_INTERVAL: 30   # check every 5 seconds
      AUTOHEAL_START_PERIOD: 120   # wait 0 seconds before first health check
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60   # Docker waits max 10 seconds (the Docker default) for a container to stop before killing during restarts (container overridable via label, see below)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
  traefik:
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.http.middlewares.admin-auth.basicauth.usersfile=/rules/traefik_users
      - traefik.http.routers.traefik-public-https.rule=Host(`traefik.{{ app_domain_name }}`)
      - traefik.http.routers.traefik-public-https.entrypoints=https
      - traefik.http.routers.traefik-public-https.tls=true
      # Use the special Traefik service api@internal with the web UI/Dashboard
      - traefik.http.routers.traefik-public-https.service=api@internal
      # Use the "le" (Let's Encrypt) resolver created below
      - traefik.http.routers.traefik-public-https.tls.certresolver=le
       # Enable HTTP Basic auth, using the middleware created above
      - traefik.http.routers.traefik-public-https.middlewares=admin-auth

      # - traefik.http.middlewares.localip.ipwhitelist.sourcerange=192.168.21.0/24, 2a01:cb08:87f6:500::/56
      # Define the port inside of the Docker service to use
      - traefik.http.services.traefik-public.loadbalancer.server.port=8585

      - traefik.http.routers.traefik-public-https.tls.domains[0].main={{ app_domain_name }}
      - traefik.http.routers.traefik-public-https.tls.domains[0].sans=*.{{ app_domain_name }}

    environment:
      - DUCKDNS_TOKEN={{ traefik_duckdns_token }}
    hostname: traefik
    image: traefik:latest
    restart: always    
    command:
      - --providers.docker
      - --providers.docker.watch
      - --providers.file.filename=/rules/rules.yaml
      - --entrypoints.https.address=:443
      - --entrypoints.websecure.address=:8443
      - --experimental.http3=true
      - --entrypoints.https.http3
      - --entrypoints.websecure.http3
      - --certificatesresolvers.le.acme.email={{ traefik_email }}
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=duckdns
      - --entrypoints.websecure.http.tls.domains[0].main={{ app_domain_name }}
      - --entrypoints.websecure.http.tls.domains[0].sans=*.{{ app_domain_name }}
      
      - --accesslog
      - --log
      - --log.level=INFO
      - --api
    networks:
      backend:
    extra_hosts:
      host.docker.internal: host-gateway

    ports:
      - 0.0.0.0:8443:8443/tcp
      - 0.0.0.0:443:443/tcp
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - traefik-public-certificates:/certificates
      - traefik-rules:/rules

  authentik-proxy:
    image: ghcr.io/goauthentik/proxy
    ports:
        - 9000:9000
        - 9443:9443
    environment:
        AUTHENTIK_HOST: http://authentik-server-1
        AUTHENTIK_INSECURE: "true"
        AUTHENTIK_TOKEN: token-generated-by-authentik
        # Starting with 2021.9, you can optionally set this too
        # when authentik_host for internal communication doesn't match the public URL
        AUTHENTIK_HOST_BROWSER: https://auth.{{ app_domain_name }}
    labels:
        traefik.enable: true
        traefik.port: 9000
        traefik.http.routers.authentik.rule: Host(`{{ app_domain_name }}`) && PathPrefix(`/outpost.goauthentik.io/`)
        # `authentik-proxy` refers to the service name in the compose file.
        traefik.http.middlewares.authentik.forwardauth.address: http://traefik-authentik-proxy-1:9000/outpost.goauthentik.io/auth/traefik
        traefik.http.middlewares.authentik.forwardauth.trustForwardHeader: true
        traefik.http.middlewares.authentik.forwardauth.authResponseHeaders: X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version
    restart: unless-stopped

  updateDuckDNSIP:
    labels:
      - traefik.enable=false
    # used to update duckdns
    # if you have a static IP, you can comment this out
    # using busybox due to it having an image for almost every platform
    image: busybox
    command: /bin/sh -c "while true; do wget -O - 'https://www.duckdns.org/update?domains={{ duckdns_subdomain }}&token={{ traefik_duckdns_token }}&ip='; sleep 1200; done"
    network_mode: bridge

networks:
  backend:
    attachable: true

volumes:
  traefik-public-certificates:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-public-certificates"
  traefik-rules:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-rules"
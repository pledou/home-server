services:
  watchtower: # auto update images
    image: containrrr/watchtower
    environment:
      DOCKER_CONFIG: /config
    volumes:
      - /etc/watchtower/config/:/config/
      - /var/run/docker.sock:/var/run/docker.sock
    command: --schedule "15 2 * * * *"

  autoheal: # restart container when healthcheck is ko
    image: willfarrell/autoheal
    restart: always
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      AUTOHEAL_INTERVAL: 30   # check every 5 seconds
      AUTOHEAL_START_PERIOD: 120   # wait 0 seconds before first health check
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: 60   # Docker waits max 10 seconds (the Docker default) for a container to stop before killing during restarts (container overridable via label, see below)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    
  traefik:
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.http.routers.traefik-public-https.rule=Host(`traefik.{{ app_domain_name }}`)
      - traefik.http.routers.traefik-public-https.entrypoints=https
      - traefik.http.routers.traefik-public-https.tls=true
      # Use the special Traefik service api@internal with the web UI/Dashboard
      - traefik.http.routers.traefik-public-https.service=api@internal
      - traefik.http.routers.traefik-public-https.tls.certresolver=le
      - traefik.http.routers.traefik-public-https.middlewares=authentik@docker
      - traefik.http.services.traefik-public.loadbalancer.server.port=8585

      - traefik.http.routers.traefik-public-https.tls.domains[0].main={{ app_domain_name }}
      - traefik.http.routers.traefik-public-https.tls.domains[0].sans=*.{{ app_domain_name }}

      - traefik.http.middlewares.authentik.forwardauth.address=http://authentik-server-1:9000/outpost.goauthentik.io/auth/traefik
      - traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version

    environment:
      - DUCKDNS_TOKEN={{ traefik_duckdns_token }}
    hostname: traefik
    image: traefik:latest
    restart: always    
    command:
      - --providers.docker
      - --providers.docker.watch
      - --providers.docker.exposedByDefault=false
      - --entrypoints.https.address=:443
      - --entrypoints.https.http3
      - --certificatesresolvers.le.acme.email={{ traefik_email }}
      - --certificatesresolvers.le.acme.storage=/certificates/acme.json
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=duckdns
      - --entrypoints.https.http.tls.domains[0].main={{ app_domain_name }}
      - --entrypoints.https.http.tls.domains[0].sans=*.{{ app_domain_name }}
      - --accesslog
      - --log
      - --log.level=INFO
      - --api
      - --metrics.prometheus=true
      - --metrics.prometheus.addrouterslabels=true
      - --entryPoints.metrics.address=:8082
      - --metrics.prometheus.entryPoint=metrics
    networks:
      backend:
    extra_hosts:
      host.docker.internal: host-gateway

    ports:
      - 0.0.0.0:8443:8443/tcp
      - 0.0.0.0:443:443/tcp
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - traefik-public-certificates:/certificates
      - traefik-rules:/rules

  updateDuckDNSIP:
    # used to update duckdns
    # if you have a static IP, you can comment this out
    # using busybox due to it having an image for almost every platform
    image: busybox
    command: /bin/sh -c "while true; do wget -O - 'https://www.duckdns.org/update?domains={{ duckdns_subdomain }}&token={{ traefik_duckdns_token }}&ip='; sleep 1200; done"
    network_mode: bridge

networks:
  backend:
    attachable: true

volumes:
  traefik-public-certificates:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-public-certificates"
  traefik-rules:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/traefik-rules"
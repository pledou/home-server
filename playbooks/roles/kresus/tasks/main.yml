# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/kresus"
    state: directory
    mode: u=g=rwx,o=rx

- name: Retrive secret
  ansible.builtin.include_tasks: "tasks/retrieve_password.yml"
  vars:
    secrets:
      - k_db_password
      - k_db1_password

- name: Create kresus provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: kresus-database
      group: 999
      owner: 999
    - name: kresus-database1
      group: 999
      owner: 999

- name: PostgreSQL upgrade check and backup for Kresus k-db
  ansible.builtin.include_tasks: "tasks/upgrade_postgres_service.yml"
  vars:
    service_name: "kresus-k-db"
    pg_container_name: "kresus-k-db-1"
    pg_database_name: "kresus"
    pg_username: "kresus"
    pg_password: "{{ k_db_password }}"
    pg_target_version: "{{ kresus_postgres_version | default('15') }}"
    pg_data_dir: "{{ docker_volumes_path }}/kresus-database"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/kresus"

- name: PostgreSQL upgrade check and backup for Kresus k-db1
  ansible.builtin.include_tasks: "tasks/upgrade_postgres_service.yml"
  vars:
    service_name: "kresus-k-db1"
    pg_container_name: "kresus-k-db1-1"
    pg_database_name: "kresus"
    pg_username: "kresus"
    pg_password: "{{ k_db1_password }}"
    pg_target_version: "{{ kresus_postgres_version | default('15') }}"
    pg_data_dir: "{{ docker_volumes_path }}/kresus-database1"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/kresus"

- name: Create docker-compose stack file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/kresus/docker-compose.yml
    mode: u=g=rwx,o=rx

- name: Deploy stack from a compose file
  community.docker.docker_compose_v2:
    pull: "always"
    build: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/kresus

- name: PostgreSQL restore after upgrade for Kresus k-db
  ansible.builtin.include_tasks: "tasks/restore_postgres_service.yml"
  vars:
    service_name: "kresus-k-db"
    pg_container_name: "kresus-k-db-1"
    pg_database_name: "kresus"
    pg_username: "kresus"
    pg_password: "{{ k_db_password }}"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/kresus"
    pg_backup_retention_days: "{{ postgres_backup_retention_days | default(7) }}"

- name: PostgreSQL restore after upgrade for Kresus k-db1
  ansible.builtin.include_tasks: "tasks/restore_postgres_service.yml"
  vars:
    service_name: "kresus-k-db1"
    pg_container_name: "kresus-k-db1-1"
    pg_database_name: "kresus"
    pg_username: "kresus"
    pg_password: "{{ k_db1_password }}"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/kresus"
    pg_backup_retention_days: "{{ postgres_backup_retention_days | default(7) }}"

- name: Configure Authentik providers and applications for Kresus
  delegate_to: localhost
  become: false
  block:
    - name: Define Kresus providers
      ansible.builtin.set_fact:
        authentik_providers:
          - name: "kresus-provider"
            external_host: "https://kresus.{{ app_domain_name }}"
          - name: "kresus1-provider"
            external_host: "https://kresus1.{{ app_domain_name }}"

    - name: Configure Authentik providers and applications
      ansible.builtin.include_tasks: "tasks/authentik_common.yml"

    - name: Define Kresus applications with provider PKs
      ansible.builtin.set_fact:
        authentik_applications:
          - name: "Kresus"
            slug: "kresus"
            provider_pk: "{{ authentik_provider_pks[0] }}"
          - name: "Kresus1"
            slug: "kresus1"
            provider_pk: "{{ authentik_provider_pks[1] }}"
      when: authentik_provider_pks is defined and authentik_provider_pks | length >= 2

    - name: Create Kresus applications
      ansible.builtin.include_tasks: "tasks/authentik_application.yml"
      loop: "{{ authentik_applications | default([]) }}"
      loop_control:
        loop_var: app_config
      when: authentik_applications is defined

  when: authentik_api_token is defined

# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/kresus"
    state: directory
    mode: u=g=rwx,o=rx
- name: Retrive secret
  ansible.builtin.include_tasks: "tasks/retrieve_password.yml"
  vars:
    secrets:
      - k_db_password
      - k_db1_password
      - k_password
      - k1_password

# - name: upgrade db
#   include_tasks: tasks/upgrade_postgres.yml
#   vars:
#     postgres_data_dir: "{{ docker_volumes_path }}/{{ item.path }}"
#     postgres_password: "{{ item.password }}"
#     postgres_container_name: "{{ item.container }}"
#     postgres_db: "kresus"
#     postgres_user: "kresus"
#   loop:
#     - path: kresus-database
#       password: k_db_password
#       container: kresus_k-db_1
#     - path: kresus-database1
#       password: k_db1_password
#       container: kresus_k-db1_1

- name: Verify kresus volume path
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: kresus-database
      group: 999
      owner: 999
    - name: kresus-database1
      group: 999
      owner: 999
    - name: kresus-woob
      group: 1001
      owner: 1000
- name: Add a user to a password file and ensure permissions are set
  become: true
  community.general.htpasswd:
    path: "{{ docker_volumes_path }}/traefik-rules/kresus_users"
    name: "p.leduc"
    password: "{{ k_password }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=
- name: Add a user to a password file and ensure permissions are set
  become: true
  community.general.htpasswd:
    path: "{{ docker_volumes_path }}/traefik-rules/kresus1_users"
    name: "v.leduc"
    password: "{{ k1_password }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=
- name: Create docker-compose stack file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/kresus/docker-compose.yml
    mode: u=g=rwx,o=rx
- name: Deploy stack from a compose file
  community.docker.docker_compose:
    pull: true
    build: true
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/kresus

# code: language=ansible
---
- name: Install kresus
  run_once: true
  block:
  - name: Verify stacks directory exists
    ansible.builtin.file:
      path: "/home/{{ ansible_user }}/home-server/stacks/kresus"
      state: directory
      mode: 0775

  - name: Load existing secret
    become: true
    ansible.builtin.fetch:
      src: "{{ docker_volumes_path }}/secrets/{{ item }}"
      dest: "files/secrets/{{ item }}"
      flat: true
    loop:
      - k_db_password
      - k_db1_password
      - k_password
      - k1_password

  - name: Generate passwords if not existant
    become: true
    ansible.builtin.set_fact:
      k_db_password: "{{ lookup('password', 'files/secrets/k_db_password chars=ascii_letters,digits length=32') }}"
      k_db1_password: "{{ lookup('password', 'files/secrets/k_db1_password chars=ascii_letters,digits length=32') }}"
      k_password: "{{ lookup('password', 'files/secrets/k_password chars=ascii_letters,digits length=32') }}"
      k1_password: "{{ lookup('password', 'files/secrets/k1_password chars=ascii_letters,digits length=32') }}"

  - name: Push new secrets
    become: true
    ansible.builtin.copy:
      src: "files/secrets/{{ item }}"
      dest: "{{ docker_volumes_path }}/secrets/{{ item }}"
      force: false
      mode: 0640
    loop:
      - k_db_password
      - k_db1_password
      - k_password
      - k1_password

  - name: remove local secret
    ansible.builtin.file:
      path: "files/secrets/{{ item }}"
      state: "absent"
    delegate_to: localhost
    loop:
      - k_db_password
      - k_db1_password
      - k_password
      - k1_password

#  - name: upgrade db
#    include_tasks: tasks/upgrade_postgres.yml
#    vars:
#      postgres_data_dir: "{{ docker_volumes_path }}/{{ item.path }}"
#      postgres_password: "{{ item.password }}"
#      postgres_container_name: "{{ item.container }}"
#      postgres_db: "kresus"
#      postgres_user: "kresus"
#    loop:
#      - path: kresus-database
#        password: k_db_password
#        container: kresus_k-db_1
#      - path: kresus-database1
#        password: k_db1_password
#        container: kresus_k-db1_1

  - name: Verify kresus volume path
    become: true
    ansible.builtin.file:
      path: "{{ docker_volumes_path }}/{{ item.name }}"
      state: directory
      owner: "{{ item.owner | default('root') }}"
      group: "{{ item.group | default('root') }}"
      mode: "{{ item.mode | default('0700') }}"
    loop:
      - name: kresus-database
        group: 999
        owner: 999
      - name: kresus-database1
        group: 999
        owner: 999
      - name: kresus-woob
        group: 1001
        owner: 1000

  - name: Add a user to a password file and ensure permissions are set
    become: true
    community.general.htpasswd:
      path: "{{ docker_volumes_path }}/traefik-rules/kresus_users"
      name: "p.leduc"
      password: "{{ k_password }}"
      owner: root
      group: root
      mode: 0640
  - name: Add a user to a password file and ensure permissions are set
    become: true
    community.general.htpasswd:
      path: "{{ docker_volumes_path }}/traefik-rules/kresus1_users"
      name: "v.leduc"
      password: "{{ k1_password }}"
      owner: root
      group: root
      mode: 0640

  - name: Create docker-compose stack file
    ansible.builtin.template:
      src: docker-compose.yml
      dest: /home/{{ ansible_user }}/home-server/stacks/kresus/docker-compose.yml
      mode: 0775

  - name: Deploy stack from a compose file
    community.docker.docker_compose:
      pull: true
      build: true
      state: present
      project_src: /home/{{ ansible_user }}/home-server/stacks/kresus

services:

  ncdb:
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - PGDATA=/var/lib/postgresql/data
    image: "{{ nextcloud_postgres_image }}:{{ nextcloud_postgres_version | default('15') }}"
    restart: always
    networks:
      - backend
    volumes:
      #- nexcloud-database-vol:/var/lib/postgresql/data:rw
      - nextcloud-database:/var/lib/postgresql/data:rw
    secrets:
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nextcloud -d nextcloud"]
      interval: 10s
      timeout: 5s
      retries: 5
  nextcloud:
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.centurylinklabs.watchtower.local-image=true

      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.constraint-label=traefik_backend
      
      - traefik.http.routers.nginx-https.rule=Host(`{{ app_domain_name }}`)
      - traefik.http.routers.nginx-https.entrypoints=https
      - traefik.http.routers.nginx-https.middlewares=nginx@docker,real-ip@docker
      - traefik.http.routers.nginx-https.tls=true
      - traefik.http.routers.nginx-https.tls.certresolver=le

      - traefik.http.services.nginx.loadbalancer.server.port=80

      - traefik.http.middlewares.nginx.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.nginx.headers.STSPreload=true
      - traefik.http.middlewares.nginx.headers.STSSeconds=315360000
      - traefik.http.middlewares.nginx.headers.browserXSSFilter=true
      - traefik.http.middlewares.nginx.headers.contentTypeNosniff=true
      - traefik.http.middlewares.nginx.headers.customFrameOptionsValue=SAMEORIGIN
      - traefik.http.middlewares.nginx.headers.forceSTSHeader=true
      - traefik.http.middlewares.nginx.headers.referrerPolicy=no-referrer
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - NEXTCLOUD_URL=https://{{app_domain_name}}
    restart: always
    hostname: nc_nextcloud
    build:
      context: ./
      dockerfile: nextcloud.Dockerfile
      target: nc_nextcloud
    networks:
      - backend
      - traefik_backend
      - ia_network
    volumes:
      - nextcloud-www:/var/www/html:Z
      - nextcloud-config:/var/www/html/config:Z
      - nextcloud-data:/var/nc-data:Z
      - nginx_config:/etc/nginx:Z
      - type: tmpfs
        target: /tmp:exec
    working_dir: /var/www/html
    depends_on:
      - ncdb
      - redis
      - elasticsearch
    secrets:
      - postgres_password

  redis:
    labels:
      - com.centurylinklabs.watchtower.enable=true
    command: redis-server --requirepass {{ redis_secret }}
    image: "{{ redis_image }}:{{ redis_version }}"
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 3s
    restart: always
    networks:
      - backend
    volumes:
      - redis-data:/data:rw
    working_dir: /data

  elasticsearch:
    labels:
      - com.centurylinklabs.watchtower.enable=true
    image: "{{ elasticsearch_image }}:{{ elasticsearch_version }}"
    networks:
      - backend
    restart: always
    environment:
      - TZ=Europe/Paris
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx2048m"
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - ELASTIC_PASSWORD={{ nc_elastic_secret }}
      - logger.org.elasticsearch.discovery=WARN
      - http.port=9200
      - xpack.license.self_generated.type=basic
    user: 1000:1000
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic_data:/usr/share/elasticsearch/data:rw

  turn_server:
    labels:
      - com.centurylinklabs.watchtower.enable=true
    command:
      - -n
      - --log-file=stdout
      - --external-ip=$$(detect-external-ip)
      - --listening-port=3478
      - --no-cli
      - --fingerprint
      - --use-auth-secret
      - --static-auth-secret=$$(cat /run/secrets/turn_secret)
      - --realm={{ app_domain_name }}
      - --total-quota=100
      - --bps-capacity=0
      - --stale-nonce
      - --no-multicast-peers
    entrypoint:
      - /bin/sh
      - -c
      - |
        export TURN_SECRET=$$(cat /run/secrets/turn_secret)
        exec docker-entrypoint.sh -n --log-file=stdout --external-ip=$$(detect-external-ip) --listening-port=3478 --no-cli --fingerprint --use-auth-secret --static-auth-secret=$$TURN_SECRET --realm={{ app_domain_name }} --total-quota=100 --bps-capacity=0 --stale-nonce --no-multicast-peers
    image: "{{ coturn_image }}:{{ coturn_version }}"
    restart: always
    networks:
      - backend
    ports:
      - 0.0.0.0:3478:3478/tcp
      - 0.0.0.0:3478:3478/udp
    volumes:
      - turnserver-data:/var/lib/coturn:rw
    secrets:
      - turn_secret

  harp:
    image: "{{ harp_image }}:{{ harp_version }}"
    restart: always
    environment:
      HP_SHARED_KEY: "{{AppAPISecret}}"
      NC_INSTANCE_URL: "https://{{ app_domain_name }}"
      # HP_TRUSTED_PROXY_IPS: "127.0.0.1/32"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
    ports:
      - 8780:8780
      - 8782:8782
    networks:
      - backend
      - traefik_backend
    labels:
      - com.centurylinklabs.watchtower.enable=false
      - traefik.enable=true
      - traefik.docker.network=traefik_backend
      - traefik.http.routers.exapps.rule="Host(`{{ app_domain_name }}`) && PathPrefix(`/exapps/`)"
      - traefik.http.routers.exapps.entrypoints=https
      - traefik.http.routers.exapps.tls=true
      - traefik.http.routers.exapps.tls.certresolver=le
      - traefik.http.routers.exapps.priority=50
      - traefik.http.routers.exapps.service=exapps-service
      - traefik.http.services.exapps-service.loadbalancer.server.port=8780
      # serversTransport is defined via Traefik file provider (harp.yml)
      # traefik.http.services.exapps-service.serversTransport.forwardingTimeouts.responseHeaderTimeout: 1800s

networks:
  traefik_backend:
    external: true
  ia_network:
    external: true
  backend:

volumes:
  nextcloud-www: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-www"
  nextcloud-config: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-config"
  nextcloud-data: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-data"
  redis-data: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-redis-data"
  nextcloud-database: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-db"
  turnserver-data: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-turnserver-data"
  nginx_config: 
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-nginx-config"
  elastic_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "{{ docker_volumes_path }}/nextcloud-elastic-data"

secrets:
  nextcloud_admin_password:
    file: "{{ docker_volumes_path }}/secrets/nextcloud_admin_secret"
  postgres_password:
    file: "{{ docker_volumes_path }}/secrets/database_user_secret"
  talk_password:
    file: "{{ docker_volumes_path }}/secrets/talk_secret"
  turn_secret:
    file: "{{ docker_volumes_path }}/secrets/turn_secret"
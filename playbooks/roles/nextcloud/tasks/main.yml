---
- name: Install nextcloud
  run_once: true
  block:
  - name: Verify stacks directory exists
    ansible.builtin.file:
      path: "/home/{{ ansible_user }}/home-server/stacks/nc"
      state: directory
      mode: 0775

  - name: Generate passwords if not existant
    become: true
    ansible.builtin.set_fact:
      nextcloud_admin_password: "{{ lookup('password', '{{ docker_volumes_path }}/secrets/nextcloud_admin_secret chars=ascii_letters,digits length=32') }}"
      database_user_secret: "{{ lookup('password', '{{ docker_volumes_path }}/secrets/database_user_secret chars=ascii_letters,digits length=32') }}"
      talk_secret: "{{ lookup('password', '{{ docker_volumes_path }}/secrets/talk_secret chars=ascii_letters,digits length=32') }}"
      redis_secret: "{{ lookup('password', '{{ docker_volumes_path }}/secrets/redis_secret chars=ascii_letters,digits length=32') }}"

#  - name: upgrade db
#    include_tasks: tasks/upgrade_postgres.yml
#    vars:
#      postgres_data_dir: "{{ docker_volumes_path }}/nextcloud-db"
#      db_container_name: nc_ncdb_1
#      postgres_password: "{{ database_user_secret }}"
#      postgres_db: "nextcloud"
#      postgres_user: "nextcloud"

  - name: Verify nextcloud volume path
    become: true
    ansible.builtin.file:
      path: "{{ docker_volumes_path }}/{{ item.name }}"
      state: directory
      owner: "{{ item.owner | default('root') }}"
      group: "{{ item.group | default('root') }}"
      mode: "{{ item.mode | default('0700') }}"
    loop:
      - name: nextcloud-redis-data
        group: 999
        owner: 999
      - name: nextcloud-turnserver-data
      - name: nextcloud-www
        owner: 33
        group: 33
      - name: nextcloud-config
        owner: 33
        group: 33
      - name: nextcloud-data
        owner: 33
        group: 33
      - name: nextcloud-db
        group: 999
        owner: 999
      - name: nextcloud-nginx-config
      - name: nextcloud-elastic-data
        owner: 1000

  - name: Copy nginx configuration file
    become: true
    ansible.builtin.copy:
      src: "{{ item }}"
      dest: "{{ docker_volumes_path }}/nextcloud-nginx-config"
      mode: '0644'
    loop:
      - nginx.conf
      - mime.types
      - fastcgi_params

  - name: Create nextcloud Dockerfile
    ansible.builtin.copy:
      src: nextcloud/Dockerfile
      dest: /home/{{ ansible_user }}/home-server/stacks/nc/nextcloud.Dockerfile
      mode: 0775

  - name: Create supervisord Dockerfile
    ansible.builtin.copy:
      src: nextcloud/supervisord.conf
      dest: /home/{{ ansible_user }}/home-server/stacks/nc/supervisord.conf
      mode: 0775

  - name: Create elastic Dockerfile
    ansible.builtin.copy:
      src: elastic/Dockerfile
      dest: /home/{{ ansible_user }}/home-server/stacks/nc/elastic.Dockerfile
      mode: 0775

  - name: Create docker-compose stack file
    ansible.builtin.template:
      src: docker-compose.yml
      dest: /home/{{ ansible_user }}/home-server/stacks/nc/docker-compose.yml
      mode: 0775

  - name: Deploy stack from a compose file
    community.docker.docker_compose:
      pull: true
      build: true
      state: present
      project_src: /home/{{ ansible_user }}/home-server/stacks/nc

  - name: Wait for nextcloud container to come up
    become: true
    ansible.builtin.wait_for:
      path: "{{ docker_volumes_path }}/nextcloud-www/lib/versioncheck.php"

  - name: Check if init is necessary
    become: true
    ansible.builtin.stat:
      path: "{{ docker_volumes_path }}/nextcloud-config/config.php"
    register: config_php

  - name: First setup nextcloud
    ansible.builtin.command: >
      docker exec --user www-data nextcloud php occ  maintenance:install
      --database psql --database-host nc-db --database-name nextcloud # TODO ou d√©faut?
      --database-user nextcloud --database-pass {{ database_user_secret }}
      --admin-user admin --admin-pass {{ nextcloud_admin_password }} --data-dir {{ docker_volumes_path }}/nextcloud-data
    when: ( not config_php.stat.exists )
    register: first_setup_nextcloud

# - name: Add missing indices
#   community.docker.docker_container_exec:
#     container: nc_nextcloud_1
#     user: www-data
#     command: php occ db:add-missing-indices
# - name: Add missing columns
#   community.docker.docker_container_exec:
#     container: nc_nextcloud_1
#     user: www-data
#     command: php occ db:add-missing-columns
#
# - name: Add missing pk
#   community.docker.docker_container_exec:
#     container: nc_nextcloud_1
#     user: www-data
#     command: php occ db:add-missing-primary-keys

# command: php occ db:convert-filecache-bigint
...

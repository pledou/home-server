# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/nc"
    state: directory
    mode: o=g=rwx,o=rx
- name: Retrive secret
  ansible.builtin.include_tasks: "retrieve_password.yml"
  vars:
    secrets:
      - nextcloud_admin_secret
      - database_user_secret
      - talk_secret
      - redis_secret

# - name: upgrade db
#   include_tasks: tasks/upgrade_postgres.yml
#   vars:
#     postgres_data_dir: "{{ docker_volumes_path }}/nextcloud-db"
#     db_container_name: nc_ncdb_1
#     postgres_password: "{{ database_user_secret }}"
#     postgres_db: "nextcloud"
#     postgres_user: "nextcloud"

- name: Verify nextcloud volume path
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: nextcloud-redis-data
      group: 999
      owner: 999
    - name: nextcloud-turnserver-data
    - name: nextcloud-www
      owner: 33
      group: 33
    - name: nextcloud-config
      owner: 33
      group: 33
    - name: nextcloud-data
      owner: 33
      group: 33
    - name: nextcloud-db
      group: 999
      owner: 999
    - name: nextcloud-nginx-config
    - name: nextcloud-elastic-data
      owner: 1000
- name: Copy nginx configuration file
  become: true
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ docker_volumes_path }}/nextcloud-nginx-config"
    mode: u=rw,g=o=r
  loop:
    - mime.types
    - fastcgi_params
  register: nginx1
- name: Copy nginx configuration file
  become: true
  ansible.builtin.template:
    src: "nginx.conf"
    dest: "{{ docker_volumes_path }}/nextcloud-nginx-config"
    mode: u=rw,g=o=r
  register: nginx2
- name: Create nextcloud Dockerfile
  ansible.builtin.copy:
    src: nextcloud/Dockerfile
    dest: /home/{{ ansible_user }}/home-server/stacks/nc/nextcloud.Dockerfile
    mode: u=rw,g=o=r
- name: Create supervisord Dockerfile
  ansible.builtin.copy:
    src: nextcloud/supervisord.conf
    dest: /home/{{ ansible_user }}/home-server/stacks/nc/supervisord.conf
    mode: u=rw,g=o=r
- name: Create elastic Dockerfile
  ansible.builtin.copy:
    src: elastic/Dockerfile
    dest: /home/{{ ansible_user }}/home-server/stacks/nc/elastic.Dockerfile
    mode: u=rw,g=o=r
- name: Create docker-compose stack file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/nc/docker-compose.yml
    mode: u=rw,g=o=r
- name: Deploy stack from a compose file
  community.docker.docker_compose:
    pull: true
    build: true
    restarted: "{{ nginx1 is changed or nginx2 is changed }}"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/nc
- name: Wait for nextcloud container to come up
  become: true
  ansible.builtin.wait_for:
    path: "{{ docker_volumes_path }}/nextcloud-www/lib/versioncheck.php"
- name: Check if init is necessary
  become: true
  ansible.builtin.stat:
    path: "{{ docker_volumes_path }}/nextcloud-config/config.php"
  register: config_php
- name: First setup nextcloud
  ansible.builtin.command: >
    docker exec --user www-data nextcloud php occ  maintenance:install
    --database psql --database-host nc-db --database-name nextcloud # TODO ou d√©faut?
    --database-user nextcloud --database-pass {{ database_user_secret }}
    --admin-user admin --admin-pass {{ nextcloud_admin_password }} --data-dir {{ docker_volumes_path }}/nextcloud-data
  when: ( not config_php.stat.exists )
  register: first_setup_nextcloud
  changed_when: first_setup_nextcloud.rc == 0
- name: Add missing db objects
  community.docker.docker_container_exec:
    container: nc_nextcloud_1
    user: www-data
    argv:
      - /bin/bash
      - "-c"
      - "php occ db:add-missing-indices ;"
      - "php occ db:add-missing-columns ;"
      - "php occ db:add-missing-primary-keys;"
      - "php occ db:convert-filecache-bigint"
  register: add_db_objects
  failed_when: add_db_objects.rc !=0
...

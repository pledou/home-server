# code: language=ansible
---
- name: Verify stacks directory exists
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/home-server/stacks/nc"
    state: directory
    mode: u=g=rwx,o=rx
- name: Retrive secret
  ansible.builtin.include_tasks: "retrieve_password.yml"
  vars:
    secrets:
      - nextcloud_admin_secret
      - database_user_secret
      - talk_secret
      - redis_secret
      - nc_elastic_secret
      - AppAPISecret
      - turn_secret

- name: Create nextcloud provisionning directories
  become: true
  ansible.builtin.file:
    path: "{{ docker_volumes_path }}/{{ item.name }}"
    state: directory
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode | default('u=rwx,g=o=') }}"
  loop:
    - name: nextcloud-redis-data
      group: 999
      owner: 999
    - name: nextcloud-turnserver-data
    - name: nextcloud-www
      owner: 33
      group: 33
    - name: nextcloud-config
      owner: 33
      group: 33
    - name: nextcloud-data
      owner: 33
      group: 33
    - name: nextcloud-db
      group: 999
      owner: 999
    - name: nextcloud-nginx-config
    - name: nextcloud-elastic-data
      owner: 1000
- name: Copy nginx configuration file
  become: true
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ docker_volumes_path }}/nextcloud-nginx-config"
    mode: u=rw,g=o=r
  loop:
    - mime.types
    - fastcgi_params
  register: nginx1
- name: Copy nginx configuration file
  become: true
  ansible.builtin.template:
    src: "nginx.conf"
    dest: "{{ docker_volumes_path }}/nextcloud-nginx-config"
    mode: u=rw,g=o=r
  register: nginx2
- name: Copy docker file
  become: true
  ansible.builtin.template:
    src: "nextcloud/Dockerfile"
    dest: "/home/{{ ansible_user }}/home-server/stacks/nc/nextcloud.Dockerfile"
    mode: u=rw,g=o=r
  register: nginx2
- name: Copy associated docker files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "/home/{{ ansible_user }}/home-server/stacks/nc/{{ item.dest }}"
    mode: u=rw,g=o=r
  loop:
    - src: nextcloud/supervisord.conf
      dest: supervisord.conf
    - src: nextcloud/fulltextsearch.sh
      dest: fulltextsearch.sh
- name: PostgreSQL upgrade check and backup for Nextcloud
  ansible.builtin.include_tasks: "tasks/upgrade_postgres_service.yml"
  vars:
    service_name: "nextcloud"
    pg_container_name: "nc-ncdb-1"
    pg_database_name: "nextcloud"
    pg_username: "nextcloud"
    pg_password: "{{ database_user_secret }}"
    pg_target_version: "{{ nextcloud_postgres_version | default('15') }}"
    pg_data_dir: "{{ docker_volumes_path }}/nextcloud-database"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/nc"

- name: Create docker-compose stack file
  ansible.builtin.template:
    src: docker-compose.yml
    dest: /home/{{ ansible_user }}/home-server/stacks/nc/docker-compose.yml
    mode: u=rw,g=o=r

- name: Try to pull latest images (continue on failure)
  community.docker.docker_compose_v2:
    pull: "always"
    state: present
    project_src: /home/{{ ansible_user }}/home-server/stacks/nc
  ignore_errors: true
  register: pull_result

- name: Warning - using local images
  ansible.builtin.debug:
    msg: "WARNING: Could not pull latest images. Deploying with existing local images."
  when: pull_result is failed

- name: Deploy stack from a compose file
  community.docker.docker_compose_v2:
    pull: "never"
    build: "always"
    state: "{{ 'restarted' if (nginx1 is changed or nginx2 is changed) else 'present' }}"
    project_src: /home/{{ ansible_user }}/home-server/stacks/nc

- name: PostgreSQL restore after upgrade for Nextcloud
  ansible.builtin.include_tasks: "tasks/restore_postgres_service.yml"
  vars:
    service_name: "nextcloud"
    pg_container_name: "nc-ncdb-1"
    pg_database_name: "nextcloud"
    pg_username: "nextcloud"
    pg_password: "{{ database_user_secret }}"
    project_src: "/home/{{ ansible_user }}/home-server/stacks/nc"
    pg_backup_retention_days: "{{ postgres_backup_retention_days | default(7) }}"

- name: Wait for nextcloud container to come up
  become: true
  ansible.builtin.wait_for:
    path: "{{ docker_volumes_path }}/nextcloud-www/lib/versioncheck.php"
- name: Check if init is necessary
  become: true
  ansible.builtin.stat:
    path: "{{ docker_volumes_path }}/nextcloud-config/config.php"
  register: config_php

- name: Nextcloud setup
  when: ( not config_php.stat.exists )
  block:
    - name: First setup nextcloud
      ansible.builtin.command:
        cmd: >
          docker exec --user www-data nc-nextcloud-1 php occ maintenance:install
          --database psql --database-host nc-db --database-name nextcloud
          --database-user nextcloud --database-pass {{ database_user_secret }}
          --admin-user admin --admin-pass {{ nextcloud_admin_password }}
          --data-dir {{ docker_volumes_path }}/nextcloud-data

    - name: Set nextcloud system config.php values
      ansible.builtin.command:
        cmd: 'docker exec --user www-data nc-nextcloud-1 php occ config:system:set {{ item }}'
      loop: '{{ nextcloud_system_config }}'

- name: Install apps
  become: true # necessary to read docker_volumes_path content
  ansible.builtin.command:
    cmd: 'docker exec --user www-data nc-nextcloud-1 php occ app:install {{ item }} --no-interaction --no-warnings'
    creates: '{{ docker_volumes_path }}/nextcloud-www/apps/{{ item }}'
  register: install_app
  loop: "{{ nextcloud_defaultapp_list }}"

- name: Configure apps config values
  ansible.builtin.command:
    cmd: 'docker exec --user www-data nc-nextcloud-1 php occ config:app:set {{ item }}'
  loop: '{{ nextcloud_apps_config }}'
  register: configure_app
  changed_when: "'set to' in configure_app.stdout or 'Config value' in configure_app.stdout"
  failed_when: false

- name: Update apps & Add missing db objects
  ansible.builtin.command:
    cmd: >
      docker exec --user www-data nc-nextcloud-1 /bin/bash -c
      "php occ app:update --all;
      php occ db:add-missing-indices;
      php occ db:add-missing-columns;
      php occ db:add-missing-primary-keys;
      php occ db:convert-filecache-bigint;
      php occ config:system:set maintenance_window_start --type=integer --value=1;"
  register: add_db_objects
  failed_when: false
  changed_when: add_db_objects.rc == 0
...
